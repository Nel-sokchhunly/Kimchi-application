var backgroundPage=ext.backgroundPage.getWindow(),require=backgroundPage.require,Filter=require("filterClasses").Filter,FilterStorage=require("filterStorage").FilterStorage,Prefs=require("prefs").Prefs,getBlockedPerPage=require("stats").getBlockedPerPage,getDecodedHostname=require("url").getDecodedHostname,page=null,pageInfo=null,activeTab=null;$((function(){localizePage();var e=chrome.extension.getBackgroundPage();function t(){SAFARI?(safari.self.hide(),setTimeout((function(){window.location.reload()}),200)):window.close()}$(".menu-entry, .menu-status, .separator").hide(),e.recordGeneralMessage("popup_opened"),e.getCurrentTabInfo((function(i){page=i.page,pageInfo=i;var a={};function o(e){e.forEach((function(e){a[e]=!0}))}function s(e){e.forEach((function(e){a[e]=!1}))}o(["div_options","separator2"]);var n=e.adblockIsPaused();n?o(["div_status_paused","separator0","div_paused_adblock","div_options"]):i.disabledSite?o(["div_status_disabled","separator0","div_pause_adblock","div_options","div_help_hide_start"]):i.whitelisted?o(["div_status_whitelisted","div_enable_adblock_on_this_page","separator0","div_pause_adblock","separator1","div_options","div_help_hide_start"]):(o(["div_pause_adblock","div_blacklist","div_whitelist","div_whitelist_page","div_show_resourcelist_start","div_report_an_ad","separator1","div_options","div_help_hide_start","separator3","block_counts"]),$("#page_blocked_count").text(getBlockedPerPage(page).toLocaleString()),$("#total_blocked_count").text(Prefs.blocked_total.toLocaleString()),$("#block_counts_help").toggle(i.settings.show_block_counts_help_link).click((function(){e.setSetting("show_block_counts_help_link",!1),ext.pages.open($(this).attr("href")),$(this).hide(),t()})));var l=parseUri(page.unicodeUrl).host,r=(i.settings.show_advanced_options,!n&&(i.disabledSite||!i.whitelisted)),c=i.disabledSite?void 0:l;for(var d in r&&e.countCache.getCustomFilterCount(c)&&o(["div_undo","separator0"]),SAFARI&&!advanced_option&&s(["div_report_an_ad","separator1"]),"www.youtube.com"===l&&/channel|user/.test(page.unicodeUrl)&&/ab_channel/.test(page.unicodeUrl)&&r&&i.settings.youtube_channel_whitelist&&($("#div_whitelist_channel").html(translate("whitelist_youtube_channel",parseUri.parseSearch(page.unicodeUrl).ab_channel)),o(["div_whitelist_channel"])),chrome.runtime&&"pljaalgmajnlogcgiohkhdmgpomjcihk"===chrome.runtime.id&&o(["div_status_beta"]),SAFARI&&i.settings.safari_content_blocking&&s(["div_paused_adblock","div_whitelist_page","div_whitelist"]),a)a[d]&&$("#"+d).show();(SAFARI||!Prefs.show_statsinpopup||n||i.disabledSite||i.whitelisted)&&$("#block_counts").hide()})),SAFARI&&($(window).load((function(){var e=$("body").outerHeight();safari.extension.popovers[0].height=e+5,safari.extension.popovers[0].width=270})),activeTab=safari.application.activeBrowserWindow.activeTab),$("#bugreport").click((function(){e.recordGeneralMessage("bugreport_clicked");ext.pages.open(""),t()})),$("#titletext").click((function(){e.recordGeneralMessage("titletext_clicked");OPERA||SAFARI,t()})),$("#div_enable_adblock_on_this_page").click((function(){e.recordGeneralMessage("enable_adblock_clicked"),e.tryToUnwhitelist(page.unicodeUrl)?(SAFARI?activeTab.url=activeTab.url:chrome.tabs.reload(),t()):$("#div_status_whitelisted").replaceWith(translate("disabled_by_filter_lists"))})),$("#div_paused_adblock").click((function(){e.recordGeneralMessage("unpause_clicked"),e.adblockIsPaused(!1),e.updateButtonUIAndContextMenus(),t()})),$("#div_undo").click((function(){e.recordGeneralMessage("undo_clicked");var i=parseUri(page.unicodeUrl).host;SAFARI||(activeTab=page),e.confirmRemovalOfCustomFiltersOnHost(i,activeTab),t()})),$("#div_whitelist_channel").click((function(){e.recordGeneralMessage("whitelist_youtube_clicked"),e.createWhitelistFilterForYoutubeChannel(page.unicodeUrl),t(),SAFARI?activeTab.url=activeTab.url:chrome.tabs.reload()})),$("#div_pause_adblock").click((function(){e.recordGeneralMessage("pause_clicked");try{pageInfo.settings.safari_content_blocking?alert(translate("safaricontentblockingpausemessage")):(e.adblockIsPaused(!0),e.updateButtonUIAndContextMenus()),t()}catch(t){e.log(t)}})),$("#div_blacklist").click((function(){e.recordGeneralMessage("blacklist_clicked"),SAFARI?e.dispatchMessage("show-blacklist-wizard"):e.emitPageBroadcast({fn:"top_open_blacklist_ui",options:{nothing_clicked:!0}},{tab:page}),t()})),$("#div_whitelist").click((function(){e.recordGeneralMessage("whitelist_domain_clicked"),SAFARI?e.dispatchMessage("show-whitelist-wizard"):e.emitPageBroadcast({fn:"top_open_whitelist_ui",options:{}},{tab:page}),t()})),$("#div_whitelist_page").click((function(){e.recordGeneralMessage("whitelist_page_clicked"),e.createPageWhitelistFilter(page.unicodeUrl),t(),SAFARI?activeTab.url=activeTab.url:chrome.tabs.reload()})),$("#div_show_resourcelist").click((function(){e.recordGeneralMessage("resource_clicked"),"Mac OS X"===backgroundPage.STATS.os&&$("#new_resourcelist_explanation").text(translate("new_resourcelist_explanation_osx")),$("#new_resourcelist_explanation").slideToggle()})),$("#div_report_an_ad").click((function(){e.recordGeneralMessage("report_ad_clicked");var i="adblock-adreport.html?url="+encodeURIComponent(page.unicodeUrl)+"&tabId="+page.id;e.ext.pages.open(e.ext.getURL(i)),t()})),$("#div_options").click((function(){e.recordGeneralMessage("options_clicked"),e.ext.pages.open(e.ext.getURL("options.html")),t()})),$("#div_help_hide").click((function(){e.recordGeneralMessage("help_clicked"),OPERA?$("#help_hide_explanation").text(translate("operabutton_how_to_hide2")).slideToggle():SAFARI?$("#help_hide_explanation").text(translate("safaributton_how_to_hide2")).slideToggle((function(){var e=$("body").outerHeight();safari.extension.popovers[0].height=e})):$("#help_hide_explanation").slideToggle()})),$("#link_open").click((function(){e.recordGeneralMessage("link_clicked"),t()}))}));